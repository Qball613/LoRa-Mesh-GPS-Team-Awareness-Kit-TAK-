; LoRa Mesh GPS Team Awareness Kit (TAK) Firmware
; Multi-board support for LilyGO T3S3 with different LoRa chips

[platformio]
default_envs = t3s3-sx1262
src_dir = src
lib_dir = lib
include_dir = include

[env]
platform = espressif32
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.partitions = default.csv

; Common libraries for all environments
lib_deps =
    jgromes/RadioLib@^7.4.0
    nanopb/Nanopb@^0.4.9
    mikalhart/TinyGPSPlus@^1.0.3
    bblanchon/ArduinoJson@^7.0.4
    adafruit/Adafruit SSD1306@^2.5.7
    adafruit/Adafruit GFX Library@^1.11.9

; Common build flags
build_flags =
    -DCORE_DEBUG_LEVEL=4
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DPB_ENABLE_MALLOC=1
    -DPB_FIELD_32BIT=1
    -DMAX_ROUTING_TABLE_SIZE=100
    -DMAX_NEIGHBOR_TABLE_SIZE=50
    -DHELLO_BEACON_INTERVAL_MS=900000
    -DGPS_UPDATE_INTERVAL_MS=60000
    -DARDUINO_LOOP_STACK_SIZE=16384
    -I.

; Include v1 protocol buffer files in build
build_src_filter = 
    +<*>
    +<../v1/*.c>

; ================================================================
; LilyGO T3-S3 V1.2 with LR1121 LoRa Chip
; ================================================================
[env:t3s3-lr1121]
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 4MB
board_upload.flash_size = 4MB
board_build.psram_type = opi

build_flags =
    ${env.build_flags}
    -I variants/esp32s3/t3s3_lr1121
    -DDEVICE_TYPE_T3S3=1
    -DHAS_LORA=1
    -DHAS_BLUETOOTH=1
    -DHAS_GPS=1

; ================================================================
; LilyGO T3-S3 V1.2 with SX1262 LoRa Chip
; ================================================================
[env:t3s3-sx1262]
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 4MB
board_upload.flash_size = 4MB
board_build.psram_type = opi

build_flags =
    ${env.build_flags}
    -I variants/esp32s3/t3s3_sx1262
    -DDEVICE_TYPE_T3S3=1
    -DHAS_LORA=1
    -DHAS_BLUETOOTH=1
    -DHAS_GPS=1

; ================================================================
; LilyGO T3-S3 V1.2 with SX1276/SX1277/SX1278 LoRa Chip
; ================================================================
[env:t3s3-sx1276]
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 4MB
board_upload.flash_size = 4MB
board_build.psram_type = opi

build_flags =
    ${env.build_flags}
    -I variants/esp32s3/t3s3_sx1276
    -DDEVICE_TYPE_T3S3=1
    -DHAS_LORA=1
    -DHAS_BLUETOOTH=1
    -DHAS_GPS=1

; ================================================================
; Native Test Environment (Desktop unit testing with Unity)
; ================================================================
[env:native]
platform = native
test_framework = unity
test_build_src = yes
test_filter = test_native_routing/*, test_hardware_safety/*

build_flags =
    -std=c++11
    -DUNIT_TEST
    -DNATIVE_TEST
    -DMAX_ROUTING_TABLE_SIZE=50
    -DMAX_NEIGHBOR_TABLE_SIZE=30
    -DMAX_DUPLICATE_CACHE_SIZE=100
    -DMAX_ALTERNATE_ROUTES=3
    ; Exclude Arduino-specific code
    -DNATIVE_PLATFORM

lib_deps =
    bblanchon/ArduinoJson@^7.0.4
